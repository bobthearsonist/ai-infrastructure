services:
  # agentgateway - MCP Gateway/Proxy
  agentgateway:
    image: ghcr.io/agentgateway/agentgateway:latest
    container_name: agentgateway
    restart: unless-stopped
    ports:
      - "3847:3847" # MCP endpoint
      - "15001:15000" # UI (internal 15000 -> external 15001)
      - "15020:15020" # Metrics (Prometheus)
    volumes:
      - ./config.yaml:/config/config.yaml:ro
      - ./memory.json:/config/memory.json
    command: ["-f", "/config/config.yaml"]
    extra_hosts:
      - "host.docker.internal:host-gateway"
    dns:
      - 127.0.0.11  # Docker embedded DNS
    networks:
      - ai-infrastructure

  # Jaeger - Distributed Tracing
  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: jaeger
    restart: unless-stopped
    ports:
      - "16686:16686" # Web UI
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    networks:
      - ai-infrastructure

  # NGINX SSL/WebSocket Proxy
  nginx-proxy:
    image: nginx:alpine
    container_name: agentgateway-proxy
    restart: unless-stopped
    ports:
      - "3443:3443" # HTTPS MCP endpoint
      - "15443:15443" # HTTPS UI
      - "9223:9223" # Chrome DevTools Protocol proxy
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certs/cert.pem:/etc/ssl/certs/cert.pem:ro
      - ./certs/key.pem:/etc/ssl/private/key.pem:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - agentgateway
    networks:
      - ai-infrastructure

networks:
  ai-infrastructure:
    name: mcpx_ai-infrastructure
    external: true
