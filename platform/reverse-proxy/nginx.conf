events {
    worker_connections 1024;
}

http {
    # Shared proxy settings
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # SSE / streaming defaults
    proxy_http_version 1.1;
    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;

    # --- Default (healthcheck) ---
    server {
        listen 80 default_server;
        server_name _;
        location /health {
            return 200 'ok';
            add_header Content-Type text/plain;
        }
        location / {
            return 444;
        }
    }

    # --- MCPX (dashboard + API) ---
    server {
        listen 80;
        server_name mcpx.localhost;

        # MCP endpoint (port 9000)
        location /mcp {
            proxy_pass http://host.docker.internal:9000;
        }

        # SSE endpoint (port 9000) - needs streaming headers
        location /sse {
            proxy_pass http://host.docker.internal:9000;
            proxy_set_header Connection '';
            proxy_buffering off;
            proxy_cache off;
        }

        # Metrics (port 3100 -> container 3000)
        location /metrics {
            proxy_pass http://host.docker.internal:3100/metrics;
        }

        # Dashboard (port 5173) - default
        location / {
            proxy_pass http://host.docker.internal:5173;
            # WebSocket support for Vite HMR
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }

    # --- Agent Gateway (API + Admin) ---
    server {
        listen 80;
        server_name agentgateway.localhost;

        # MCP API (port 3847) - SSE streaming
        location /mcp {
            proxy_pass http://host.docker.internal:3847;
            proxy_set_header Connection '';
            proxy_buffering off;
            proxy_cache off;
        }

        # Admin UI (port 15001) - default
        location / {
            proxy_pass http://host.docker.internal:15001;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }

    # --- Grafana ---
    server {
        listen 80;
        server_name grafana.localhost;

        location / {
            proxy_pass http://host.docker.internal:3000;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }

    # --- Jaeger ---
    server {
        listen 80;
        server_name jaeger.localhost;

        location / {
            proxy_pass http://host.docker.internal:16686;
        }
    }

    # --- Prometheus ---
    server {
        listen 80;
        server_name prometheus.localhost;

        location / {
            proxy_pass http://host.docker.internal:9090;
        }
    }
}
